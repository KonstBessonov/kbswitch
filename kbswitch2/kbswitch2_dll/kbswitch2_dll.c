#include "../common.inl"

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

// http://www.codeproject.com/KB/DLL/data_seg_share.aspx

#pragma bss_seg(".shared")
HKL g_hKL;
#pragma bss_seg()

#pragma comment(linker,"/section:.shared,RWS")

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

BOOL WINAPI DllMain(HANDLE hDLL,DWORD fdwReason,LPVOID lpvReserved)
{
	(void)hDLL,(void)fdwReason,(void)lpvReserved;

	return TRUE;
}

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

__declspec(dllexport)
void SetKeyboardLayout(HKL hKL)
{
	LOG("%s: hkl=%p",__FUNCTION__,hKL);

	g_hKL=hKL;
}

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

static void SetWindowKeyboardLayout(const char *pReason,HWND hWnd)
{
	LOG("%s: hwnd=%p hkl=%p.",pReason,hWnd,g_hKL);

 	if(g_hKL)
 		PostMessage(hWnd,WM_INPUTLANGCHANGEREQUEST,0,(LPARAM)g_hKL);
}

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

__declspec(dllexport)
LRESULT CALLBACK KBSwitchCBTHookProc(int nCode,WPARAM wParam,LPARAM lParam)
{
	switch(nCode)
	{
	case HCBT_SETFOCUS:
		{
			SetWindowKeyboardLayout("HCBT_SETFOCUS",(HWND)wParam);
		}
		break;
	}

	return CallNextHookEx(NULL,nCode,wParam,lParam);
}

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
